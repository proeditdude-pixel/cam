<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Gesture Arcade</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fingerpose@0.0.2/dist/fingerpose.js"></script>

    <style>
        :root {
            --bg: #020617;
            --card: #0f172a;
            --accent: #38bdf8;
            --danger: #f43f5e;
            --success: #10b981;
            --text: #f8fafc;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: var(--bg); color: var(--text);
            font-family: -apple-system, system-ui, sans-serif;
            overflow: hidden;
        }

        /* Home Menu */
        #home-menu {
            position: absolute; inset: 0; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
        }

        .menu-title { font-size: 2.5rem; font-weight: 900; margin-bottom: 40px; letter-spacing: -1px; }

        .game-grid { display: flex; gap: 20px; padding: 20px; }

        .game-card {
            background: var(--card); border: 1px solid #334155;
            padding: 30px; border-radius: 24px; width: 160px; text-align: center;
            cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .game-card:hover { transform: translateY(-10px); border-color: var(--accent); box-shadow: 0 0 30px rgba(56, 189, 248, 0.2); }
        .game-card svg { width: 50px; height: 50px; fill: var(--accent); margin-bottom: 15px; }

        /* Game Containers */
        .game-view { position: absolute; inset: 0; display: none; }
        .active { display: block !important; }

        .back-btn {
            position: absolute; top: 20px; left: 20px; z-index: 1000;
            background: rgba(255,255,255,0.1); border: none; color: white;
            padding: 10px 15px; border-radius: 12px; font-weight: bold; cursor: pointer;
        }

        /* RPS Elements */
        #rps-ui { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); text-align: center; width: 100%; }
        #rps-result { font-size: 4rem; font-weight: 900; color: var(--accent); text-shadow: 0 0 20px rgba(56,189,248,0.5); }

        /* Neon Dodge Elements */
        #dodge-canvas { width: 100vw; height: 100vh; display: block; }
        #dodge-ui { position: absolute; top: 20px; right: 20px; text-align: right; }

        #video-hidden { display: none; }
        #loading-overlay { 
            position: absolute; inset: 0; background: var(--bg); 
            display: none; align-items: center; justify-content: center; z-index: 200; 
        }
    </style>
</head>
<body>

    <div id="loading-overlay">Initializing AI Engine...</div>

    <div id="home-menu">
        <h1 class="menu-title">GESTURE ARCADE</h1>
        <div class="game-grid">
            <div class="game-card" onclick="launchGame('rps')">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5-9h10v2H7z"/></svg>
                <h3>RPS ARENA</h3>
            </div>
            <div class="game-card" onclick="launchGame('dodge')">
                <svg viewBox="0 0 24 24"><path d="M13.13 22.19l-1.63-3.83c1.57-.64 3.04-1.55 4.37-2.71l2.86 3.29c-1.71 1.41-3.63 2.5-5.6 3.25M5.27 18.94l2.86-3.29c1.33 1.16 2.8 2.07 4.37 2.71l-1.63 3.83c-1.97-.75-3.89-1.84-5.6-3.25M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
                <h3>NEON DODGE</h3>
            </div>
        </div>
    </div>

    <div id="game-rps" class="game-view">
        <button class="back-btn" onclick="exitGame()">EXIT</button>
        <video id="rps-video" playsinline style="width:100%; height:100%; object-fit:cover; transform:scaleX(-1);"></video>
        <div id="rps-ui">
            <div id="rps-countdown" style="font-size: 5rem; font-weight: 900;"></div>
            <div id="rps-result">READY?</div>
            <p>Score: <span id="p-score">0</span> - <span id="c-score">0</span></p>
        </div>
    </div>

    <div id="game-dodge" class="game-view">
        <button class="back-btn" onclick="exitGame()">EXIT</button>
        <canvas id="dodge-canvas"></canvas>
        <div id="dodge-ui">
            <h2 id="dodge-score">0</h2>
            <div id="shield-status" style="color: var(--accent); font-weight: bold;">SHIELD: READY</div>
        </div>
    </div>

    <video id="video-hidden" playsinline muted></video>

    <script>
        let currentMode = null;
        let hands, camera;
        let GE, scores = {p:0, c:0};
        let dodgeState = { active: false, x:0, y:0, score:0, life:100, enemies:[], shield: false, shieldCharge: 100 };
        
        // --- Shared AI Core ---
        async function setupAI() {
            document.getElementById('loading-overlay').style.display = 'flex';
            
            // Gestures
            const rock = new fp.GestureDescription('rock');
            const paper = new fp.GestureDescription('paper');
            const scissors = new fp.GestureDescription('scissors');
            [0,1,2,3,4].forEach(f => { rock.addCurl(f, fp.FingerCurl.FullCurl, 1.0); paper.addCurl(f, fp.FingerCurl.NoCurl, 1.0); });
            scissors.addCurl(fp.Finger.Index, fp.FingerCurl.NoCurl, 1.0);
            scissors.addCurl(fp.Finger.Middle, fp.FingerCurl.NoCurl, 1.0);
            [fp.Finger.Thumb, fp.Finger.Ring, fp.Finger.Pinky].forEach(f => scissors.addCurl(f, fp.FingerCurl.FullCurl, 1.0));
            GE = new fp.GestureEstimator([rock, paper, scissors]);

            hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.6});
            hands.onResults(onResults);

            camera = new Camera(document.getElementById('video-hidden'), {
                onFrame: async () => { await hands.send({image: document.getElementById('video-hidden')}); },
                width: 640, height: 480
            });

            await camera.start();
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function onResults(results) {
            if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) return;
            const landmarks = results.multiHandLandmarks[0];

            if (currentMode === 'rps') {
                const mapped = landmarks.map(l => [l.x * 400, l.y * 400, l.z]);
                const gesture = GE.estimate(mapped, 7.5);
                if (gesture.gestures.length > 0) handleRPS(gesture.gestures[0].name);
            } 
            else if (currentMode === 'dodge') {
                dodgeState.x = (1 - landmarks[8].x) * window.innerWidth;
                dodgeState.y = landmarks[8].y * window.innerHeight;
                
                // Detection for Powerup (Open Palm = Shield)
                const mapped = landmarks.map(l => [l.x * 400, l.y * 400, l.z]);
                const gesture = GE.estimate(mapped, 7.5);
                dodgeState.shield = (gesture.gestures.some(g => g.name === 'paper') && dodgeState.shieldCharge > 0);
            }
        }

        // --- RPS Logic ---
        let rpsCooldown = false;
        async function handleRPS(player) {
            if (rpsCooldown) return;
            rpsCooldown = true;
            
            const countEl = document.getElementById('rps-countdown');
            for(let i=3; i>0; i--) { countEl.innerText = i; await new Promise(r => setTimeout(r, 600)); }
            countEl.innerText = "";

            const cpu = ['rock', 'paper', 'scissors'][Math.floor(Math.random()*3)];
            let res = (player === cpu) ? "DRAW" : 
                      ((player==='rock'&&cpu==='scissors')||(player==='paper'&&cpu==='rock')||(player==='scissors'&&cpu==='paper')) ? "WIN" : "LOSE";
            
            if(res === "WIN") scores.p++; if(res === "LOSE") scores.c++;
            document.getElementById('rps-result').innerText = `CPU: ${cpu.toUpperCase()} | ${res}`;
            document.getElementById('p-score').innerText = scores.p;
            document.getElementById('c-score').innerText = scores.c;

            setTimeout(() => { document.getElementById('rps-result').innerText = "READY?"; rpsCooldown = false; }, 2000);
        }

        // --- Dodge Logic ---
        function dodgeLoop() {
            if (currentMode !== 'dodge') return;
            const ctx = document.getElementById('dodge-canvas').getContext('2d');
            ctx.fillStyle = 'rgba(2, 6, 23, 0.2)';
            ctx.fillRect(0,0,window.innerWidth, window.innerHeight);

            // Player
            ctx.shadowBlur = 15; ctx.shadowColor = dodgeState.shield ? '#10b981' : '#38bdf8';
            ctx.fillStyle = ctx.shadowColor;
            ctx.beginPath(); ctx.arc(dodgeState.x, dodgeState.y, 20, 0, Math.PI*2); ctx.fill();

            // Enemies
            if (Math.random() < 0.05) dodgeState.enemies.push({x: Math.random()*window.innerWidth, y: -50, s: 5+Math.random()*5});
            
            dodgeState.enemies.forEach((e, i) => {
                e.y += e.s;
                ctx.fillStyle = '#f43f5e';
                ctx.fillRect(e.x, e.y, 30, 30);

                let dist = Math.hypot(dodgeState.x - e.x, dodgeState.y - e.y);
                if (dist < 40) {
                    if (!dodgeState.shield) { alert("Hit! Score: " + dodgeState.score); exitGame(); }
                    else { dodgeState.enemies.splice(i, 1); dodgeState.shieldCharge -= 20; }
                }
            });
            
            if(dodgeState.shield) dodgeState.shieldCharge -= 0.5;
            else if(dodgeState.shieldCharge < 100) dodgeState.shieldCharge += 0.2;
            document.getElementById('shield-status').innerText = `SHIELD: ${Math.floor(dodgeState.shieldCharge)}%`;
            document.getElementById('dodge-score').innerText = dodgeState.score++;

            requestAnimationFrame(dodgeLoop);
        }

        // --- Navigation ---
        function launchGame(mode) {
            currentMode = mode;
            document.getElementById('home-menu').style.display = 'none';
            document.querySelectorAll('.game-view').forEach(v => v.classList.remove('active'));
            document.getElementById('game-' + mode).classList.add('active');
            
            if (!hands) setupAI();
            if (mode === 'dodge') {
                const cvs = document.getElementById('dodge-canvas');
                cvs.width = window.innerWidth; cvs.height = window.innerHeight;
                dodgeState.enemies = []; dodgeState.score = 0; dodgeState.shieldCharge = 100;
                dodgeLoop();
            } else {
                document.getElementById('rps-video').srcObject = document.getElementById('video-hidden').srcObject;
                document.getElementById('rps-video').play();
            }
        }

        function exitGame() {
            currentMode = null;
            document.getElementById('home-menu').style.display = 'flex';
            document.querySelectorAll('.game-view').forEach(v => v.classList.remove('active'));
        }
    </script>
</body>
</html>
