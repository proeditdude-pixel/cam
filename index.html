<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>V5</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fingerpose@0.0.2/dist/fingerpose.js"></script>

    <style>
        :root {
            --bg: #09090b;
            --surface: #18181b;
            --accent: #3b82f6;
            --text-main: #fafafa;
            --text-dim: #71717a;
        }

        body {
            margin: 0; background: var(--bg); color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex; align-items: center; justify-content: center;
            height: 100vh; overflow: hidden;
        }

        #game-card {
            width: 95vw; max-width: 420px; background: var(--surface);
            border-radius: 32px; padding: 24px; border: 1px solid #27272a;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }

        /* Header & Scores */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .score-pill { background: #27272a; padding: 8px 16px; border-radius: 12px; font-weight: 700; font-size: 0.9rem; }
        .score-val { color: var(--accent); margin-left: 5px; }

        /* Stage */
        .stage {
            position: relative; width: 100%; aspect-ratio: 1;
            background: #000; border-radius: 24px; overflow: hidden;
            border: 2px solid #27272a;
        }

        video { position: absolute; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        /* Computer Reveal Overlay */
        #cpu-overlay {
            position: absolute; inset: 0; z-index: 5;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(9,9,11,0.7); backdrop-filter: blur(4px);
            transition: opacity 0.3s; opacity: 0; pointer-events: none;
        }
        #cpu-overlay.visible { opacity: 1; }
        #cpu-icon-svg { width: 80px; height: 80px; fill: var(--accent); margin-bottom: 10px; }

        /* Countdown & Results */
        #status-area { margin-top: 20px; height: 100px; display: flex; flex-direction: column; align-items: center; }
        #countdown { font-size: 3.5rem; font-weight: 900; color: var(--accent); line-height: 1; }
        #result-text { font-size: 1.5rem; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; }
        #sub-text { color: var(--text-dim); font-size: 0.9rem; margin-top: 5px; }

        /* Start Button */
        #boot-screen {
            position: absolute; inset: 0; z-index: 20; background: var(--surface);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .btn-primary {
            background: var(--accent); color: white; border: none;
            padding: 16px 32px; border-radius: 16px; font-weight: 700;
            font-size: 1.1rem; cursor: pointer;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="game-card">
    <div class="header">
        <div class="score-pill">YOU <span id="p-score" class="score-val">0</span></div>
        <div style="font-weight: 800; font-size: 1.2rem;">ARENA</div>
        <div class="score-pill">CPU <span id="c-score" class="score-val">0</span></div>
    </div>

    <div class="stage">
        <video id="input_video" playsinline></video>
        
        <div id="cpu-overlay">
            <div id="cpu-icon-container"></div>
            <div id="cpu-label" style="font-weight: 800; color: white;">ROCK</div>
        </div>

        <div id="boot-screen">
            <button class="btn-primary" id="start-btn">START MATCH</button>
            <p style="color: var(--text-dim); font-size: 0.8rem; margin-top: 15px;">Requires Camera Access</p>
        </div>
    </div>

    <div id="status-area">
        <div id="countdown"></div>
        <div id="result-text">READY?</div>
        <div id="sub-text">Hold up your hand to begin</div>
    </div>
</div>

<div class="hidden">
    <svg id="icon-rock" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5-9h10v2H7z"/></svg>
    <svg id="icon-paper" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
    <svg id="icon-scissors" viewBox="0 0 24 24"><path d="M19 3c-1.1 0-2 .9-2 2 0 .22.04.43.12.63L9.74 12c.14.29.26.59.35.91L18.12 11c.43.62 1.15 1 1.88 1 1.33 0 2.42-1.08 2.42-2.42S21.33 7.16 20 7.16c-.22 0-.43.04-.63.12L11 15.38c-.29-.14-.59-.26-.91-.35L11 7.88c-.62-.43-1-1.15-1-1.88 0-1.33 1.08-2.42 2.42-2.42S14.84 4.67 14.84 6c0 .22-.04.43-.12.63L22.26 12c-.14-.29-.26-.59-.35-.91L13.88 13c-.43-.62-1.15-1-1.88-1-1.33 0-2.42 1.08-2.42 2.42s1.08 2.42 2.42 2.42c.22 0 .43-.04.63-.12L21 8.62c.29.14.59.26.91.35l-8.12 2c.62.43 1 1.15 1 1.88 0 1.33-1.08 2.42-2.42 2.42S10 14.17 11.16 13c.22 0 .43-.04.63-.12L20.26 5c.14.29.26.59.35.91L12.88 8c.43.62 1.15 1 1.88 1 1.33 0 2.42-1.08 2.42-2.42S16.17 4.16 15 4.16c-.22 0-.43.04-.63.12L6.16 12c.14.29.26.59.35.91l8.12-2c-.43-.62-1.15-1-1.88-1-1.33 0-2.42 1.08-2.42 2.42s1.08 2.42 2.42 2.42c.22 0 .43-.04.63-.12L6 17.16c-.29-.14-.59-.26-.91-.35l2.12-7.12c-.62-.43-1-1.15-1-1.88 0-1.33 1.08-2.42 2.42-2.42S11.08 6.42 10 7.75c-.22 0-.43.04-.63.12L2 15c.14.29.26.59.35.91L10.12 14c.43.62 1.15 1 1.88 1 1.33 0 2.42-1.08 2.42-2.42s-1.09-2.42-2.42-2.42z"/></svg>
</div>

<script>
    const video = document.getElementById('input_video');
    const cpuOverlay = document.getElementById('cpu-overlay');
    const countdownEl = document.getElementById('countdown');
    const resultEl = document.getElementById('result-text');
    const subText = document.getElementById('sub-text');
    
    let scores = { p: 0, c: 0 };
    let isGameState = "IDLE"; // IDLE, COUNTDOWN, REVEAL
    let GE, currentDetectedGesture = null;

    function updateScore() {
        document.getElementById('p-score').innerText = scores.p;
        document.getElementById('c-score').innerText = scores.c;
    }

    async function startCountdown() {
        isGameState = "COUNTDOWN";
        resultEl.innerText = "";
        subText.innerText = "Keep your hand visible...";
        
        for (let i = 3; i > 0; i--) {
            countdownEl.innerText = i;
            await new Promise(r => setTimeout(r, 800));
        }
        
        countdownEl.innerText = "";
        resolveRound();
    }

    function resolveRound() {
        isGameState = "REVEAL";
        const choices = ['rock', 'paper', 'scissors'];
        const cpuChoice = choices[Math.floor(Math.random() * 3)];
        const playerChoice = currentDetectedGesture || 'rock'; // Default if lost tracking

        // UI Reveal
        const iconData = document.getElementById('icon-' + cpuChoice).cloneNode(true);
        iconData.id = "cpu-icon-svg";
        document.getElementById('cpu-icon-container').innerHTML = '';
        document.getElementById('cpu-icon-container').appendChild(iconData);
        document.getElementById('cpu-label').innerText = cpuChoice.toUpperCase();
        cpuOverlay.classList.add('visible');

        // Logic
        if (playerChoice === cpuChoice) {
            resultEl.innerText = "DRAW";
        } else if (
            (playerChoice === 'rock' && cpuChoice === 'scissors') ||
            (playerChoice === 'paper' && cpuChoice === 'rock') ||
            (playerChoice === 'scissors' && cpuChoice === 'paper')
        ) {
            resultEl.innerText = "VICTORY";
            scores.p++;
        } else {
            resultEl.innerText = "DEFEAT";
            scores.c++;
        }
        
        updateScore();
        subText.innerText = "Resetting...";

        setTimeout(() => {
            cpuOverlay.classList.remove('visible');
            resultEl.innerText = "READY?";
            subText.innerText = "Show your hand to play again";
            isGameState = "IDLE";
        }, 3000);
    }

    function onResults(results) {
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0].map(l => [l.x * 400, l.y * 400, l.z]);
            const gesture = GE.estimate(landmarks, 7.5);

            if (gesture.gestures.length > 0) {
                currentDetectedGesture = gesture.gestures.sort((a,b) => b.confidence - a.confidence)[0].name;
                
                if (isGameState === "IDLE") {
                    startCountdown();
                }
            }
        } else {
            currentDetectedGesture = null;
        }
    }

    async function init() {
        document.getElementById('start-btn').innerText = "LOADING...";
        
        // Setup Gestures
        const rock = new fp.GestureDescription('rock');
        const paper = new fp.GestureDescription('paper');
        const scissors = new fp.GestureDescription('scissors');
        [0,1,2,3,4].forEach(f => rock.addCurl(f, fp.FingerCurl.FullCurl, 1.0));
        [0,1,2,3,4].forEach(f => paper.addCurl(f, fp.FingerCurl.NoCurl, 1.0));
        scissors.addCurl(fp.Finger.Index, fp.FingerCurl.NoCurl, 1.0);
        scissors.addCurl(fp.Finger.Middle, fp.FingerCurl.NoCurl, 1.0);
        [fp.Finger.Thumb, fp.Finger.Ring, fp.Finger.Pinky].forEach(f => scissors.addCurl(f, fp.FingerCurl.FullCurl, 1.0));
        GE = new fp.GestureEstimator([rock, paper, scissors]);

        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.6});
        hands.onResults(onResults);

        const camera = new Camera(video, {
            onFrame: async () => { await hands.send({image: video}); },
            width: 640, height: 480
        });

        await camera.start();
        document.getElementById('boot-screen').classList.add('hidden');
    }

    document.getElementById('start-btn').addEventListener('click', init);
</script>
</body>
</html>
